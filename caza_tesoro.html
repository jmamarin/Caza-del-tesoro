<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Caza del Tesoro ‚ö°</title>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Fredoka+One&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --color-primary: #FF6B6B;
      --color-secondary: #4ECDC4;
      --color-accent: #FFE66D;
      --color-dark: #292F36;
      --color-light: #F7FFF7;
      --color-timer: #FF6B6B;
      --color-success: #2e7d32;
      --color-error: #d32f2f;
      --color-warning: #ffa000;
      --color-purple: #7b1fa2;
      --color-text: #333333;
      --color-text-light: #f5f5f5;
      --color-sorteo: #9C27B0;
      --color-ronda1: #2196F3;
      --color-ronda2: #4CAF50;
      --color-ronda3: #FF9800;
      --color-final: #F44336;
      --color-resumen: #607D8B;
      --color-text-dark: #2d3436;
      --color-text-headers: #ffeaa7;
    }
    
    body {
      font-family: 'Fredoka One', cursive;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--color-text-dark);
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    header {
      background: rgba(41, 47, 54, 0.9);
      color: var(--color-accent);
      padding: 1rem;
      text-align: center;
      font-size: 3rem;
      font-family: 'Luckiest Guy', cursive;
      letter-spacing: 3px;
      text-shadow: 3px 3px 0 var(--color-dark);
      position: relative;
      z-index: 10;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      border-bottom: 5px solid var(--color-accent);
      transform-style: preserve-3d;
      animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }
    
    header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="%23FFE66D" stroke-width="2" fill="none" opacity="0.2"/></svg>');
      opacity: 0.3;
    }
    
    nav {
      display: flex;
      justify-content: center;
      background: rgba(255, 107, 107, 0.9);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      padding: 0.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(5px);
    }
    
    nav button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.8rem 1.5rem;
      margin: 0.3rem;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-radius: 50px;
      font-family: 'Fredoka One', cursive;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    nav button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 7px 14px rgba(0,0,0,0.2);
      background: rgba(255, 255, 255, 0.3);
    }
    
    nav button.active {
      background: var(--color-accent);
      color: var(--color-dark);
      box-shadow: 0 8px 15px rgba(0,0,0,0.3);
      transform: translateY(-3px);
    }
    
    nav button.active::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 4px;
      background: white;
      border-radius: 2px;
      animation: navUnderline 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes navUnderline {
      from { width: 0; opacity: 0; }
      to { width: 60%; opacity: 1; }
    }
    
    .tab {
      display: none;
      padding: 2rem;
      animation: fadeIn 0.6s cubic-bezier(0.39, 0.575, 0.565, 1) both;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab.active {
      display: block;
    }
    
    h2 {
      font-family: 'Luckiest Guy', cursive;
      font-size: 2.5rem;
      text-align: center;
      margin: 1rem 0 2rem;
      text-shadow: 3px 3px 0 var(--color-dark);
      position: relative;
      display: inline-block;
      left: 50%;
      transform: translateX(-50%);
      color: var(--color-text-headers);
    }
    
    #portada h2 { color: var(--color-sorteo); }
    #ronda1 h2 { color: var(--color-ronda1); }
    #ronda2 h2 { color: var(--color-ronda2); }
    #ronda3 h2 { color: var(--color-ronda3); }
    #final h2 { color: var(--color-final); }
    #resumen h2 { color: var(--color-resumen); }
    
    h2::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, transparent, currentColor, transparent);
      border-radius: 5px;
    }
    
    .group {
      background: rgba(255, 255, 255, 0.15);
      padding: 2rem;
      margin: 2rem 0;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .group:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      border-color: var(--color-accent);
    }
    
    .group::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transform: rotate(45deg);
      pointer-events: none;
    }
    
    button {
      background: var(--color-secondary);
      color: var(--color-dark);
      border: none;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-family: 'Fredoka One', cursive;
      margin: 1rem 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
    }
    
    button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      background: var(--color-accent);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    .editable {
      display: inline-block;
      width: 50%;
      padding: 0.6rem;
      margin: 0.3rem 0;
      font-size: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.8);
      color: var(--color-dark);
      font-family: 'Fredoka One', cursive;
    }
    
    .editable:focus {
      outline: none;
      border-color: var(--color-accent);
      background-color: white;
      color: var(--color-dark);
    }
    
    .group-name {
      background-color: rgba(255, 230, 109, 0.7) !important;
      font-weight: bold;
      font-size: 1.3rem;
      width: 65% !important;
      color: var(--color-dark) !important;
    }
    
    .final-winner {
      font-weight: bold;
      color: var(--color-success);
      font-size: 1.5rem;
      text-align: center;
      margin: 1rem 0;
      text-shadow: 2px 2px 0 var(--color-dark);
    }
    
    .docente-container {
      display: flex;
      align-items: center;
      margin: 0.5rem 0;
    }
    
    .docente-label {
      margin-left: 8px;
      font-weight: bold;
      color: var(--color-accent) !important;
      font-size: 1rem;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }
    
    button:disabled {
      background-color: rgba(178, 223, 219, 0.5) !important;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .file-input {
      display: none;
    }
    
    .file-label {
      display: inline-block;
      padding: 0.8rem 1.5rem;
      background-color: var(--color-secondary);
      color: var(--color-dark);
      border-radius: 50px;
      cursor: pointer;
      margin: 0.5rem;
      font-size: 1rem;
      font-family: 'Fredoka One', cursive;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .file-label:hover {
      background: var(--color-accent);
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .ronda-winner {
      font-weight: bold;
      color: var(--color-success);
      margin: 1rem 0;
      font-size: 1.3rem;
      text-align: center;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .pending {
      color: var(--color-warning);
      font-style: italic;
      text-align: center;
      font-size: 1.2rem;
    }
    
    .rondas-container {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem;
    }
    
    .ronda-column {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.15);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      color: var(--color-text-dark);
    }
    
    .ronda-column li {
      margin-bottom: 0.5rem;
    }
    
    .ronda-column li ul li {
      font-weight: normal !important;
    }
    
    .pregunta-item {
      display: flex;
      align-items: center;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    
    .pregunta-texto {
      margin-right: 0.8rem;
      font-weight: bold;
      min-width: 120px;
      color: var(--color-text-dark);
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    
    .pregunta-texto .pregunta-numero {
      font-size: 0.9rem;
    }
    
    .pregunta-texto .pregunta-puntos {
      font-size: 0.8rem;
      color: var(--color-text-headers);
    }
    
    .check-container {
      display: flex;
      gap: 0.5rem;
    }
    
    .check-option {
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.8);
      font-size: 1rem;
      width: 30px;
      text-align: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: var(--color-dark);
    }
    
    .check-option:hover {
      transform: scale(1.1);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    .check-option.selected {
      background: var(--color-success);
      color: white;
    }
    
    .check-option.fallo.selected {
      background: var(--color-error);
      color: white;
    }
    
    .check-option.bloqueado {
      opacity: 0.7;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .check-option.bloqueado.selected {
      opacity: 1;
    }
    
    .puntos-total {
      font-weight: bold;
      margin-left: auto;
      min-width: 90px;
      text-align: right;
      font-size: 1.1rem;
      color: var(--color-accent);
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }
    
    .finalistas-container {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    
    .finalista-item {
      background: rgba(227, 242, 253, 0.2);
      padding: 1.2rem;
      border-radius: 12px;
      color: var(--color-text-dark);
    }
    
    .grupo-container {
      margin-bottom: 1.5rem;
      padding: 1.2rem;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      transition: all 0.3s;
      color: var(--color-text-dark);
    }
    
    .grupo-container.eliminado {
      background-color: rgba(255, 235, 238, 0.2);
      border-left: 5px solid var(--color-error);
    }
    
    .grupo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    
    .grupo-nombre {
      font-weight: bold;
      color: var(--color-accent);
      font-size: 1.2rem;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
    }
    
    .grupo-nombre.eliminado {
      color: var(--color-error);
    }
    
    .eliminado-texto {
      color: var(--color-error);
      font-weight: bold;
      text-align: center;
      margin: 0.8rem 0;
      font-size: 1.1rem;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .preguntas-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .preguntas-linea {
      display: flex;
      gap: 0.8rem;
      overflow-x: auto;
      padding-bottom: 0.8rem;
    }
    
    .pregunta-box {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.8rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-width: 120px;
      transition: all 0.3s;
      color: var(--color-text-dark);
    }
    
    .pregunta-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .pregunta-box.desempate {
      background: rgba(123, 31, 162, 0.3);
      border-left: 4px solid var(--color-purple);
    }
    
    .participantes-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
    
    .participante-group {
      background: rgba(255, 255, 255, 0.15);
      padding: 1.2rem;
      border-radius: 15px;
      line-height: 1.4;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
      color: var(--color-text-dark);
    }
    
    .participante-group:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .congratulations {
      font-size: 2.5rem;
      color: var(--color-success);
      text-align: center;
      margin: 1.5rem 0;
      font-weight: bold;
      text-shadow: 3px 3px 0 var(--color-dark);
      font-family: 'Luckiest Guy', cursive;
    }
    
    .winner-info {
      background: rgba(232, 245, 233, 0.3);
      padding: 1.5rem;
      border-radius: 15px;
      margin: 1.5rem 0;
      color: var(--color-text-dark);
    }
    
    .download-pdf {
      background-color: var(--color-error) !important;
      margin-top: 1.5rem;
    }
    
    .download-pdf:hover {
      background-color: #b71c1c !important;
    }
    
    .pregunta-desempate {
      color: var(--color-purple);
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .controls-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
    
    .resumen-card {
      background: rgba(255, 255, 255, 0.15);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      color: var(--color-text-dark);
    }
    
    .resumen-card h3 {
      color: var(--color-accent);
      margin-top: 0;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 0.8rem;
      font-size: 1.5rem;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .puntuacion-item {
      display: flex;
      justify-content: space-between;
      margin: 0.8rem 0;
      font-size: 1.1rem;
    }
    
    .puntuacion-item .nombre {
      font-weight: bold;
    }
    
    .puntuacion-item .puntos {
      color: var(--color-accent);
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .mejor-ronda {
      background-color: rgba(255, 193, 7, 0.3) !important;
    }
    
    .empate-message {
      color: var(--color-error);
      font-weight: bold;
      margin: 1rem 0;
      font-size: 1.2rem;
      text-align: center;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .ganador-info {
      background: rgba(232, 245, 233, 0.3);
      padding: 1.5rem;
      border-radius: 15px;
      margin: 1.5rem 0;
      color: var(--color-text-dark);
    }
    
    .timer-container {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--color-timer);
      color: white;
      padding: 1rem;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
      z-index: 1000;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 3px solid white;
      transform-origin: center;
      cursor: pointer;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }
    
    .timer-container.active {
      transform: translate(-50%, -50%) scale(5);
      left: 50%;
      top: 50%;
      background: #ff4757;
      box-shadow: 0 0 0 100vh rgba(0,0,0,0.7);
      z-index: 2000;
    }
    
    .timer-container::before {
      content: "";
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      border: 2px dashed white;
      border-radius: 50%;
      animation: spin 10s linear infinite;
      opacity: 0.7;
      pointer-events: none;
    }
    
    .timer-container::after {
      content: "";
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border: 2px dotted white;
      border-radius: 50%;
      animation: spinReverse 15s linear infinite;
      opacity: 0.4;
      pointer-events: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes spinReverse {
      0% { transform: rotate(360deg); }
      100% { transform: rotate(0); }
    }
    
    .timer-button {
      background: white !important;
      color: var(--color-timer) !important;
      padding: 0.4rem 0.8rem !important;
      font-size: 0.8rem !important;
      margin-top: 5px !important;
      border-radius: 20px !important;
      transition: all 0.3s !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
    }
    
    .timer-button:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--color-accent);
      opacity: 0;
      z-index: 9999;
      animation: confetti 5s ease-out;
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    @media (max-width: 768px) {
      header {
        font-size: 2rem;
      }
      
      nav button {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      
      .timer-container {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
      
      .timer-container.active {
        transform: scale(3);
      }
      
      h2 {
        font-size: 1.8rem;
      }
      
      .participantes-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .rondas-container {
        flex-direction: column;
      }
      
      .resumen-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .participantes-container {
        grid-template-columns: 1fr;
      }
      
      .editable {
        width: 70%;
      }
    }

    /* Estilos para el modal de instrucciones */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    .modal-content {
      background: var(--color-light);
      padding: 2rem;
      border-radius: 15px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      font-family: 'Fredoka One', cursive;
    }
    .modal-content h2 {
      color: var(--color-primary);
      margin-bottom: 1rem;
    }
    .modal-content p {
      color: var(--color-text);
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .modal-content button {
      background: var(--color-secondary);
      color: var(--color-dark);
    }
    .file-label {
      text-transform: none;
    }
  </style>
</head>
<body>
  <div id="instructionsModal" class="modal">
    <div class="modal-content">
      <h2>¬°Bienvenidos a la Caza del Tesoro!</h2>
      <p>En este juego, cada equipo competir√° en varias rondas respondiendo preguntas. Usa los botones para seleccionar respuestas, acumula puntos y ¬°descubre qui√©n es el gran campe√≥n!</p>
      <button onclick="cerrarModal()">¬°Entendido!</button>
    </div>
  </div>

  <!-- Efectos sonoros -->
  <audio id="correct-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
  <audio id="wrong-sound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
  <audio id="win-sound" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>
  <audio id="click-sound" src="https://www.soundjay.com/buttons/sounds/button-35.mp3"></audio>
  <audio id="transition-sound" src="https://www.soundjay.com/buttons/sounds/button-35.mp3"></audio>
  <audio id="sorteo-sound" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3"></audio>
  <audio id="success-sound" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>
  <audio id="pdf-sound" src="https://www.soundjay.com/misc/sounds/magic-chime-01.mp3"></audio>
  <audio id="fanfare-sound" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>
  <audio id="eliminado-sound" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3"></audio>

  <div id="timer" class="timer-container" style="display: none;">
    <span id="timer-display">15</span>
    <button class="timer-button" id="timer-button" onclick="toggleTemporizador()">Iniciar</button>
  </div>

  <header>
    <h1>‚ö° CAZA DEL TESORO ‚ö°</h1>
  </header>
  
  <nav>
    <button onclick="showTab('participantes')" class="active">üë• Equipos</button>
    <button onclick="showTab('portada')">üé≤ Sorteo</button>
    <button onclick="showTab('ronda1')">1Ô∏è‚É£ Ronda 1</button>
    <button onclick="showTab('ronda2')">2Ô∏è‚É£ Ronda 2</button>
    <button onclick="showTab('ronda3')">3Ô∏è‚É£ Ronda 3</button>
    <button onclick="showTab('final')">üèÜ Final</button>
    <button onclick="showTab('resumen')">üìä Resumen</button>
    <button onclick="toggleMute()" id="mute-button">üîá Silenciar</button>
  </nav>

  <div id="participantes" class="tab active">
    <h2>üë• Equipos Participantes</h2>
    <div class="group">
      <div class="controls-container">
        <input type="file" id="file-input" class="file-input" accept=".json" onchange="cargarDesdeArchivo(this)">
        <label for="file-input" class="file-label">üìÇ Cargar desde archivo</label>
        <button onclick="descargarEquipos()" class="file-label">‚¨áÔ∏è Descargar equipos</button>
      </div>
      <div id="grupos-container" class="participantes-container"></div>
    </div>
  </div>

  <div id="portada" class="tab">
    <h2>üé≤ Sorteo de Equipos</h2>
    <div class="group">
      <button id="btn-sorteo" onclick="sortearPortada()">üé∞ Realizar Sorteo</button>
      <div id="resultado-sorteo" class="rondas-container"></div>
    </div>
  </div>

  <div id="ronda1" class="tab">
    <h2>1Ô∏è‚É£ Primera Ronda</h2>
    <div class="group">
      <div id="grupos-ronda1"></div>
      <div id="ganador-ronda1" class="ronda-winner"></div>
      <div id="info-ganador-ronda1" class="ganador-info" style="display: none;"></div>
    </div>
  </div>

  <div id="ronda2" class="tab">
    <h2>2Ô∏è‚É£ Segunda Ronda</h2>
    <div class="group">
      <div id="grupos-ronda2"></div>
      <div id="ganador-ronda2" class="ronda-winner"></div>
      <div id="info-ganador-ronda2" class="ganador-info" style="display: none;"></div>
    </div>
  </div>

  <div id="ronda3" class="tab">
    <h2>3Ô∏è‚É£ Tercera Ronda</h2>
    <div class="group">
      <div id="grupos-ronda3"></div>
      <div id="ganador-ronda3" class="ronda-winner"></div>
      <div id="info-ganador-ronda3" class="ganador-info" style="display: none;"></div>
    </div>
  </div>

  <div id="final" class="tab">
    <h2>üèÜ Ronda Final</h2>
    <div class="group">
      <button id="btn-sortear-final" onclick="sortearOrdenFinal()">üîÄ Sortear Orden</button>
      <div id="grupos-final"></div>
      <div id="ganador-final" class="final-winner"></div>
      <div id="info-ganador-final" class="winner-info" style="display: none;"></div>
    </div>
  </div>

  <div id="resumen" class="tab">
    <h2>üìä Resumen Final</h2>
    <div class="group">
      <div id="resumen-contenido" class="resumen-grid"></div>
      <button id="btn-download-pdf" class="download-pdf" onclick="generarPDF()">üì• Descargar PDF</button>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    
    const seleccionados = {};
    const puntuaciones = {
      ronda1: {},
      ronda2: {},
      ronda3: {},
      final: {}
    };
    const respuestas = {
      ronda1: {},
      ronda2: {},
      ronda3: {},
      final: {}
    };
    const eliminados = {
      ronda1: {},
      ronda2: {},
      ronda3: {},
      final: {}
    };
    let timerInterval;
    let ordenFinal = [];
    let ganadoresRondas = {
      ronda1: null,
      ronda2: null,
      ronda3: null
    };
    let sorteoRealizado = false;
    let sorteoFinalRealizado = false;
    let temporizadorActivo = false;
    let muted = false;
    
    document.addEventListener('DOMContentLoaded', function() {
      precargarGrupos();
      actualizarResumen();
      document.querySelectorAll('nav button, button').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!muted) document.getElementById('click-sound').play();
        });
      });
    });

    function toggleMute() {
      muted = !muted;
      document.getElementById('mute-button').textContent = muted ? 'üîà Activar sonido' : 'üîá Silenciar';
      if (!muted) document.getElementById('click-sound').play();
    }

    function cerrarModal() {
      document.getElementById('instructionsModal').style.display = 'none';
    }

    function precargarGrupos() {
      const container = document.getElementById('grupos-container');
      for (let i = 1; i <= 9; i++) {
        const grupo = document.createElement("div");
        grupo.className = "participante-group";
        grupo.innerHTML = `
          <h3><input type="text" class="editable group-name" value="Equipo ${i}"></h3>
          <ul>
            <li>
              <div class="docente-container">
                <input type="text" class="editable" value="Docente ${i}">
                <span class="docente-label">Docente</span>
              </div>
            </li>
            <li><input type="text" class="editable" value="Estudiante 1"></li>
            <li><input type="text" class="editable" value="Estudiante 2"></li>
            <li><input type="text" class="editable" value="Estudiante 3"></li>
            <li><input type="text" class="editable" value="Estudiante 4"></li>
          </ul>
        `;
        container.appendChild(grupo);
      }
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      const index = ["participantes", "portada", "ronda1", "ronda2", "ronda3", "final", "resumen"].indexOf(tabId);
      document.querySelectorAll('nav button')[index].classList.add('active');
      
      if (!muted) document.getElementById('transition-sound').play();
      
      if (tabId === 'resumen') {
        actualizarResumen();
      }
      
      if (['ronda1', 'ronda2', 'ronda3', 'final'].includes(tabId)) {
        document.getElementById('timer').style.display = 'flex';
      } else {
        document.getElementById('timer').style.display = 'none';
        detenerTemporizador();
      }
    }

    function sortearPortada() {
      if (!muted) document.getElementById('sorteo-sound').play();
      const btnSorteo = document.getElementById("btn-sorteo");
      btnSorteo.disabled = true;
      sorteoRealizado = true;
      
      const div = document.getElementById("resultado-sorteo");
      div.innerHTML = `
        <div class="ronda-column" id="ronda1-col"></div>
        <div class="ronda-column" id="ronda2-col"></div>
        <div class="ronda-column" id="ronda3-col"></div>
      `;

      const grupos = obtenerGrupos();
      const copia = [...grupos];
      
      for (let ronda = 1; ronda <= 3; ronda++) {
        const seleccion = [];
        for (let i = 0; i < 3; i++) {
          if (copia.length === 0) break;
          const index = Math.floor(Math.random() * copia.length);
          seleccion.push(copia.splice(index, 1)[0]);
        }
        seleccionados[`ronda${ronda}`] = seleccion;
        document.getElementById(`ronda${ronda}-col`).innerHTML = `
          <h3>üéØ Ronda ${ronda}</h3>
          <ul>${seleccion.map(gr => `
            <li><strong>${gr.nombre} (${gr.docente})</strong>
              <ul>${gr.miembros.slice(1).map(m => `<li>${m}</li>`).join('')}</ul>
            </li>`).join('')}
          </ul>
        `;
      }

      renderizarRondas();
    }

    function obtenerGrupos() {
      return Array.from(document.querySelectorAll("#grupos-container .participante-group")).map(group => {
        const nombreGrupo = group.querySelector("h3 input").value.trim();
        const miembros = Array.from(group.querySelectorAll("ul li input")).map(el => el.value.trim());
        const docente = miembros[0] || "";
        return { nombre: nombreGrupo, docente, miembros };
      });
    }

    function estaEliminado(ronda, grupo) {
      if (!respuestas[ronda] || !respuestas[ronda][grupo]) return false;
      
      const fallos = [
        respuestas[ronda][grupo][1] === 0,
        respuestas[ronda][grupo][2] === 0,
        respuestas[ronda][grupo][3] === 0
      ].filter(Boolean).length;
      
      return fallos >= 2;
    }

    function todasLasPreguntasRespondidas(ronda, grupo) {
      return respuestas[ronda] && 
             respuestas[ronda][grupo] && 
             respuestas[ronda][grupo][1] !== undefined && 
             respuestas[ronda][grupo][2] !== undefined && 
             respuestas[ronda][grupo][3] !== undefined;
    }

    function renderizarRondas() {
      for (let ronda = 1; ronda <= 3; ronda++) {
        const rondaKey = `ronda${ronda}`;
        if (seleccionados[rondaKey]) {
          const div = document.getElementById(`grupos-ronda${ronda}`);
          div.innerHTML = `
            <h3>Grupos participantes</h3>
            ${seleccionados[rondaKey].map(gr => {
              const eliminado = estaEliminado(rondaKey, gr.nombre);
              const preguntasBaseRespondidas = [1, 2, 3].every(p => 
                respuestas[rondaKey]?.[gr.nombre]?.[p] !== undefined
              );
              
              return `
              <div class="grupo-container ${eliminado ? 'eliminado' : ''}">
                <div class="grupo-header">
                  <span class="grupo-nombre ${eliminado ? 'eliminado' : ''}">${gr.nombre} (${gr.docente})</span>
                  <span class="puntos-total" id="puntos-${rondaKey}-${gr.nombre.replace(/\s+/g, '-')}">${puntuaciones[rondaKey][gr.nombre] || 0} puntos</span>
                </div>
                ${eliminado ? '<div class="eliminado-texto">Equipo eliminado</div>' : ''}
                <div class="preguntas-container">
                  <div class="preguntas-linea">
                    ${[1,2,3,4,5].map(pregunta => {
                      const desempateHabilitado = pregunta <= 3 ? true : preguntasBaseRespondidas;
                      const bloqueado = ganadoresRondas[rondaKey] || 
                                     (eliminado && pregunta > 3) || 
                                     (pregunta > 3 && !desempateHabilitado);
                      
                      return `
                      <div class="pregunta-box ${pregunta > 3 ? 'desempate' : ''}">
                        <div class="pregunta-item">
                          <span class="pregunta-texto">
                            <span class="pregunta-numero">${pregunta <= 3 ? `Pregunta ${pregunta}` : `Desempate ${pregunta-3}`}</span>
                            <span class="pregunta-puntos">(${pregunta <=3 ? pregunta : 3} punto${pregunta > 1 ? 's' : ''})</span>
                          </span>
                          <div class="check-container">
                            <div class="check-option 
                              ${respuestas[rondaKey]?.[gr.nombre]?.[pregunta] === (pregunta <=3 ? pregunta : 3) ? 'selected' : ''} 
                              ${bloqueado ? 'bloqueado' : ''}" 
                              onclick="${bloqueado ? '' : `toggleRespuesta('${rondaKey}', '${gr.nombre}', ${pregunta}, true)`}">‚úì</div>
                            <div class="check-option 
                              ${respuestas[rondaKey]?.[gr.nombre]?.[pregunta] === 0 ? 'selected fallo' : ''} 
                              ${bloqueado ? 'bloqueado' : ''}" 
                              onclick="${bloqueado ? '' : `toggleRespuesta('${rondaKey}', '${gr.nombre}', ${pregunta}, false)`}">‚úó</div>
                          </div>
                        </div>
                      </div>`;
                    }).join('')}
                  </div>
                </div>
              </div>
            `}).join('')}
            ${!ganadoresRondas[rondaKey] ? '<button onclick="calcularGanador(\'' + rondaKey + '\')">üèÖ Calcular ganador</button>' : ''}
            <div id="ganador-${rondaKey}" class="ronda-winner">${ganadoresRondas[rondaKey] ? `Ganador: ${ganadoresRondas[rondaKey].nombre} con ${ganadoresRondas[rondaKey].puntos} puntos` : ''}</div>
            ${ganadoresRondas[rondaKey] ? `
              <div class="ganador-info">
                <h3>üèÜ Informaci√≥n del equipo ganador</h3>
                <p><strong>Grupo:</strong> ${ganadoresRondas[rondaKey].nombre}</p>
                <p><strong>Docente:</strong> ${ganadoresRondas[rondaKey].docente}</p>
                <p><strong>Participantes:</strong></p>
                <ul>
                  ${ganadoresRondas[rondaKey].miembros.map(m => `<li>${m}</li>`).join('')}
                </ul>
              </div>
            ` : ''}`;
        }
      }
      
      const finalDiv = document.getElementById("grupos-final");
      if (sorteoFinalRealizado && ordenFinal.length > 0) {
        finalDiv.innerHTML = `
          <h3>Grupos finalistas</h3>
          <div id="finalistas-container" class="finalistas-container">
            ${ordenFinal.map((grupo, index) => {
              const eliminado = estaEliminado('final', grupo.nombre);
              const preguntasBaseRespondidas = [1, 2, 3].every(p => 
                respuestas.final?.[grupo.nombre]?.[p] !== undefined
              );
              
              return `
              <div class="grupo-container ${eliminado ? 'eliminado' : ''}">
                <div class="grupo-header">
                  <span class="grupo-nombre ${eliminado ? 'eliminado' : ''}">${index + 1}. ${grupo.nombre} (${grupo.docente})</span>
                  <span class="puntos-total" id="puntos-final-${grupo.nombre.replace(/\s+/g, '-')}">${puntuaciones.final[grupo.nombre] || 0} puntos</span>
                </div>
                ${eliminado ? '<div class="eliminado-texto">Equipo eliminado</div>' : ''}
                <div class="preguntas-container">
                  <div class="preguntas-linea">
                    ${[1,2,3,4,5].map(pregunta => {
                      const desempateHabilitado = pregunta <= 3 ? true : preguntasBaseRespondidas;
                      const bloqueado = eliminado || (pregunta > 3 && !desempateHabilitado);
                      
                      return `
                      <div class="pregunta-box ${pregunta > 3 ? 'desempate' : ''}">
                        <div class="pregunta-item">
                          <span class="pregunta-texto">
                            <span class="pregunta-numero">${pregunta <= 3 ? `Pregunta ${pregunta}` : `Desempate ${pregunta-3}`}</span>
                            <span class="pregunta-puntos">(${pregunta <=3 ? pregunta : 3} punto${pregunta > 1 ? 's' : ''})</span>
                          </span>
                          <div class="check-container">
                            <div class="check-option 
                              ${respuestas.final?.[grupo.nombre]?.[pregunta] === (pregunta <=3 ? pregunta : 3) ? 'selected' : ''} 
                              ${bloqueado ? 'bloqueado' : ''}" 
                              onclick="${bloqueado ? '' : `toggleRespuesta('final', '${grupo.nombre}', ${pregunta}, true)`}">‚úì</div>
                            <div class="check-option 
                              ${respuestas.final?.[grupo.nombre]?.[pregunta] === 0 ? 'selected fallo' : ''} 
                              ${bloqueado ? 'bloqueado' : ''}" 
                              onclick="${bloqueado ? '' : `toggleRespuesta('final', '${grupo.nombre}', ${pregunta}, false)`}">‚úó</div>
                          </div>
                        </div>
                      </div>`;
                    }).join('')}
                  </div>
                </div>
              </div>
            `}).join('')}
          </div>
          ${!document.getElementById('ganador-final').textContent.includes("Ganador:") ? 
            '<button onclick="calcularGanador(\'final\')">üëë Proclamar Campe√≥n</button>' : ''}`;
      } else {
        finalDiv.innerHTML = '<p class="pending">Pulsa "Sortear orden de participaci√≥n" para comenzar la final</p>';
      }
    }

    function toggleRespuesta(ronda, grupo, pregunta, acierto) {
      if (respuestas[ronda]?.[grupo]?.[pregunta] !== undefined && 
          ((acierto && respuestas[ronda][grupo][pregunta] > 0) || 
           (!acierto && respuestas[ronda][grupo][pregunta] === 0))) {
        delete respuestas[ronda][grupo][pregunta];
      } else {
        if (!respuestas[ronda][grupo]) respuestas[ronda][grupo] = {};
        respuestas[ronda][grupo][pregunta] = acierto ? (pregunta <= 3 ? pregunta : 3) : 0;
        if (!muted) {
          if (acierto) {
            document.getElementById('correct-sound').play();
          } else {
            document.getElementById('wrong-sound').play();
          }
        }
      }

      const eliminado = estaEliminado(ronda, grupo);
      if (eliminado) {
        eliminados[ronda][grupo] = true;
        if (!muted) document.getElementById('eliminado-sound').play();
      }

      let total = 0;
      for (let p = 1; p <= 5; p++) {
        if (respuestas[ronda][grupo] && respuestas[ronda][grupo][p] !== undefined) {
          total += respuestas[ronda][grupo][p];
        }
      }

      const puntosElement = document.getElementById(`puntos-${ronda}-${grupo.replace(/\s+/g, '-')}`);
      if (puntosElement) puntosElement.textContent = `${total} puntos`;

      puntuaciones[ronda][grupo] = total;
      
      renderizarRondas();
    }

    function calcularGanador(ronda) {
      if (!muted) {
        if (ronda === 'final') document.getElementById('fanfare-sound').play();
        else document.getElementById('success-sound').play();
      }
      
      document.querySelectorAll(`#grupos-${ronda} .check-option`).forEach(checkbox => {
        checkbox.classList.add('bloqueado');
      });

      const puntuacionRonda = puntuaciones[ronda];
      let maxPuntos = -1;
      let ganadores = [];
      
      for (const grupo in puntuacionRonda) {
        if (estaEliminado(ronda, grupo)) continue;
        
        if (puntuacionRonda[grupo] > maxPuntos) {
          maxPuntos = puntuacionRonda[grupo];
          ganadores = [grupo];
        } else if (puntuacionRonda[grupo] === maxPuntos) {
          const puntosDesempate1 = respuestas[ronda][grupo][4] || 0;
          const puntosDesempate2 = respuestas[ronda][grupo][5] || 0;
          const puntosDesempateGanador = (respuestas[ronda][ganadores[0]][4] || 0) + (respuestas[ronda][ganadores[0]][5] || 0);
          
          if ((puntosDesempate1 + puntosDesempate2) > puntosDesempateGanador) {
            maxPuntos = puntuacionRonda[grupo];
            ganadores = [grupo];
          } else if ((puntosDesempate1 + puntosDesempate2) === puntosDesempateGanador) {
            ganadores.push(grupo);
          }
        }
      }
      
      const ganadorDiv = document.getElementById(`ganador-${ronda}`);
      if (ganadores.length > 0 && maxPuntos > 0) {
        if (ganadores.length > 1) {
          ganadorDiv.innerHTML = `<div class="empate-message">¬°Empate! Los equipos ${ganadores.join(', ')} tienen ${maxPuntos} puntos. Usa las preguntas de desempate para resolverlo.</div>`;
          
          document.querySelectorAll(`#grupos-${ronda} .pregunta-box.desempate .check-option`).forEach(checkbox => {
            checkbox.classList.remove('bloqueado');
          });
          
          if (ronda !== 'final') {
            ganadoresRondas[ronda] = null;
          }
        } else {
          if (ronda !== 'final') {
            ganadorDiv.innerHTML = `Ganador: ${ganadores.join(', ')} con ${maxPuntos} puntos`;
            
            ganadoresRondas[ronda] = {
              nombre: ganadores.join(', '),
              puntos: maxPuntos,
              ronda: parseInt(ronda.substring(5)),
              docente: obtenerDocente(ganadores[0]),
              miembros: obtenerMiembros(ganadores[0])
            };
            
            actualizarFinalistas();
          } else {
            ganadorDiv.innerHTML = `Ganador: ${ganadores.join(', ')} con ${maxPuntos} puntos`;
            
            const infoGanadorDiv = document.getElementById('info-ganador-final');
            infoGanadorDiv.style.display = 'block';
            infoGanadorDiv.innerHTML = `
              <div class="congratulations">¬°ENHORABUENA! üéâ</div>
              <h3>Ganador: ${ganadores.join(', ')} con ${maxPuntos} puntos</h3>
              <p><strong>Docente:</strong> ${obtenerDocente(ganadores[0])}</p>
              <p><strong>Participantes:</strong></p>
              <ul>
                ${obtenerMiembros(ganadores[0]).map(m => `<li>${m}</li>`).join('')}
              </ul>`;
            if (!muted) document.getElementById('win-sound').play();
          }
        }
      } else {
        ganadorDiv.innerHTML = "Introduce las respuestas primero";
      }
      
      actualizarResumen();
      renderizarRondas();
    }

    function actualizarFinalistas() {
      ordenFinal = [];
      for (let r = 1; r <= 3; r++) {
        const rondaKey = `ronda${r}`;
        if (ganadoresRondas[rondaKey]) {
          ordenFinal.push(ganadoresRondas[rondaKey]);
        }
      }
      if (ordenFinal.length === 3) {
        renderizarRondas();
      }
    }

    function sortearOrdenFinal() {
      if (!muted) document.getElementById('sorteo-sound').play();
      let todosGanadores = true;
      for (let r = 1; r <= 3; r++) {
        if (!ganadoresRondas[`ronda${r}`]) {
          todosGanadores = false;
          break;
        }
      }
      
      if (todosGanadores) {
        const btnSortearFinal = document.getElementById("btn-sortear-final");
        btnSortearFinal.disabled = true;
        sorteoFinalRealizado = true;
        
        for (let i = ordenFinal.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [ordenFinal[i], ordenFinal[j]] = [ordenFinal[j], ordenFinal[i]];
        }
        renderizarRondas();
      } else {
        alert("Primero deben completarse las tres rondas y calcular sus ganadores");
      }
    }

    function obtenerDocente(nombreGrupo) {
      const grupos = document.querySelectorAll("#grupos-container .participante-group");
      for (const grupo of grupos) {
        if (grupo.querySelector("h3 input").value.trim() === nombreGrupo) {
          return grupo.querySelector("ul li input").value.trim();
        }
      }
      return "";
    }

    function obtenerMiembros(nombreGrupo) {
      const grupos = document.querySelectorAll("#grupos-container .participante-group");
      for (const grupo of grupos) {
        if (grupo.querySelector("h3 input").value.trim() === nombreGrupo) {
          return Array.from(grupo.querySelectorAll("ul li input")).slice(1).map(el => el.value.trim());
        }
      }
      return [];
    }

    function toggleTemporizador() {
      if (temporizadorActivo) {
        detenerTemporizador();
      } else {
        iniciarTemporizador();
      }
    }

    function iniciarTemporizador() {
      const timerDisplay = document.getElementById('timer-display');
      const timerButton = document.getElementById('timer-button');
      let tiempo = 15;
      timerDisplay.textContent = tiempo;
      document.getElementById('timer').style.backgroundColor = '#ff4757';
      document.getElementById('timer').classList.add('active');
      timerButton.textContent = 'Detener';
      temporizadorActivo = true;
      
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        tiempo--;
        timerDisplay.textContent = tiempo;
        
        if (tiempo <= 0) {
          detenerTemporizador();
          document.getElementById('timer').style.backgroundColor = '#ff0000';
          
          for (let i = 0; i < 50; i++) {
            createConfetti();
          }
        }
      }, 1000);
    }

    function detenerTemporizador() {
      clearInterval(timerInterval);
      document.getElementById('timer-display').textContent = '15';
      document.getElementById('timer').style.backgroundColor = '#FF6B6B';
      document.getElementById('timer').classList.remove('active');
      document.getElementById('timer-button').textContent = 'Iniciar';
      temporizadorActivo = false;
    }

    function createConfetti() {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.backgroundColor = getRandomColor();
      document.body.appendChild(confetti);
      
      setTimeout(() => {
        confetti.remove();
      }, 5000);
    }

    function getRandomColor() {
      const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F1C', '#A463F2'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function actualizarResumen() {
      const grupos = obtenerGrupos();
      const resumenDiv = document.getElementById('resumen-contenido');
      resumenDiv.innerHTML = '';
      
      const ganadorFinalDiv = document.getElementById('ganador-final');
      if (ganadorFinalDiv && ganadorFinalDiv.textContent.includes("Ganador:")) {
        const nombreGanador = ganadorFinalDiv.textContent.match(/Ganador: (.*) con/)[1];
        const puntosGanador = ganadorFinalDiv.textContent.match(/con (\d+) puntos/)[1];
        
        resumenDiv.innerHTML += `
          <div class="resumen-card">
            <h3>üèÜ ¬°Ganador Final!</h3>
            <div class="congratulations">${nombreGanador}</div>
            <p><strong>Docente:</strong> ${obtenerDocente(nombreGanador)}</p>
            <p><strong>Puntuaci√≥n:</strong> ${puntosGanador} puntos</p>
            <p><strong>Participantes:</strong></p>
            <ul>
              ${obtenerMiembros(nombreGanador).map(m => `<li>${m}</li>`).join('')}
            </ul>
          </div>`;
      } else {
        resumenDiv.innerHTML += `
          <div class="resumen-card">
            <h3>üèÜ Final</h3>
            <p class="pending">Pendiente de realizar</p>
          </div>`;
      }
      
      const gruposConPuntuacion = grupos.map(grupo => {
        const ronda1 = puntuaciones.ronda1[grupo.nombre] || 0;
        const ronda2 = puntuaciones.ronda2[grupo.nombre] || 0;
        const ronda3 = puntuaciones.ronda3[grupo.nombre] || 0;
        const final = puntuaciones.final[grupo.nombre] || 0;
        
        return {
          nombre: grupo.nombre,
          docente: grupo.docente,
          ronda1,
          ronda2,
          ronda3,
          final
        };
      }).filter(g => g.ronda1 > 0 || g.ronda2 > 0 || g.ronda3 > 0 || g.final > 0);
      
      if (gruposConPuntuacion.length > 0) {
        resumenDiv.innerHTML += `
          <div class="resumen-card">
            <h3>üìä Puntuaciones por Equipo</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background-color: var(--color-primary); color: white;">
                  <th style="padding: 8px; text-align: left;">Equipo</th>
                  <th style="padding: 8px; text-align: center;">R1</th>
                  <th style="padding: 8px; text-align: center;">R2</th>
                  <th style="padding: 8px; text-align: center;">R3</th>
                  <th style="padding: 8px; text-align: center;">Final</th>
                </tr>
              </thead>
              <tbody>
                ${gruposConPuntuacion.map(grupo => {
                  const rondas = [grupo.ronda1, grupo.ronda2, grupo.ronda3, grupo.final];
                  const mejorRonda = Math.max(...rondas);
                  return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                      <td style="padding: 8px;">${grupo.nombre}</td>
                      <td style="padding: 8px; text-align: center; ${grupo.ronda1 === mejorRonda ? 'background-color: rgba(255, 193, 7, 0.3); font-weight: bold;' : ''}">${grupo.ronda1}</td>
                      <td style="padding: 8px; text-align: center; ${grupo.ronda2 === mejorRonda ? 'background-color: rgba(255, 193, 7, 0.3); font-weight: bold;' : ''}">${grupo.ronda2}</td>
                      <td style="padding: 8px; text-align: center; ${grupo.ronda3 === mejorRonda ? 'background-color: rgba(255, 193, 7, 0.3); font-weight: bold;' : ''}">${grupo.ronda3}</td>
                      <td style="padding: 8px; text-align: center; ${grupo.final === mejorRonda ? 'background-color: rgba(255, 193, 7, 0.3); font-weight: bold;' : ''}">${grupo.final}</td>
                    </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
      }
      
      resumenDiv.innerHTML += `
        <div class="resumen-card">
          <h3>üìã Resumen de Rondas</h3>
          <div class="puntuacion-item">
            <span class="nombre">Ronda 1</span>
            <span class="puntos">${ganadoresRondas.ronda1 ? ganadoresRondas.ronda1.nombre + ' (' + ganadoresRondas.ronda1.puntos + ' pts)' : 'Pendiente'}</span>
          </div>
          <div class="puntuacion-item">
            <span class="nombre">Ronda 2</span>
            <span class="puntos">${ganadoresRondas.ronda2 ? ganadoresRondas.ronda2.nombre + ' (' + ganadoresRondas.ronda2.puntos + ' pts)' : 'Pendiente'}</span>
          </div>
          <div class="puntuacion-item">
            <span class="nombre">Ronda 3</span>
            <span class="puntos">${ganadoresRondas.ronda3 ? ganadoresRondas.ronda3.nombre + ' (' + ganadoresRondas.ronda3.puntos + ' pts)' : 'Pendiente'}</span>
          </div>
        </div>`;
    }

    function cargarDesdeArchivo(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data.grupos)) {
            const container = document.getElementById("grupos-container");
            container.innerHTML = '';
            
            data.grupos.forEach((grupoData, index) => {
              const nuevoGrupo = document.createElement("div");
              nuevoGrupo.className = "participante-group";
              nuevoGrupo.innerHTML = `
                <h3><input type="text" class="editable group-name" value="${grupoData.nombre || `Equipo ${index+1}`}"></h3>
                <ul>
                  <li>
                    <div class="docente-container">
                      <input type="text" class="editable" value="${grupoData.docente || `Docente ${index+1}`}">
                      <span class="docente-label">Docente</span>
                    </div>
                  </li>
                  ${(grupoData.miembros || ["Estudiante 1", "Estudiante 2", "Estudiante 3", "Estudiante 4"]).map((m, i) => `
                    <li><input type="text" class="editable" value="${m || `Estudiante ${i+1}`}"></li>
                  `).join('')}
                </ul>
              `;
              container.appendChild(nuevoGrupo);
            });
          }
        } catch (error) {
          alert("Error al cargar el archivo: " + error.message);
        }
      };
      reader.readAsText(file);
    }

    function descargarEquipos() {
      if (!muted) document.getElementById('click-sound').play();
      const equipos = obtenerGrupos();
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ grupos: equipos }, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "equipos.json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function generarPDF() {
      if (!muted) document.getElementById('pdf-sound').play();
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.setTextColor(0, 77, 64);
      doc.text("Resultados de la Caza del Tesoro", 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      
      let yPos = 30;
      
      const ganadorFinalDiv = document.getElementById('ganador-final');
      if (ganadorFinalDiv && ganadorFinalDiv.textContent.includes("Ganador:")) {
        const nombreGanador = ganadorFinalDiv.textContent.match(/Ganador: (.*) con/)[1];
        const puntosGanador = ganadorFinalDiv.textContent.match(/con (\d+) puntos/)[1];
        
        doc.setFontSize(16);
        doc.text("Ganador Final", 105, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(12);
        doc.text(`Equipo: ${nombreGanador} - ${puntosGanador} puntos`, 14, yPos);
        yPos += 7;
        doc.text(`Docente: ${obtenerDocente(nombreGanador)}`, 20, yPos);
        yPos += 7;
        doc.text(`Participantes: ${obtenerMiembros(nombreGanador).join(', ')}`, 20, yPos);
        yPos += 15;
      } else {
        doc.setFontSize(16);
        doc.text("Final Pendiente", 105, yPos, { align: 'center' });
        yPos += 15;
      }
      
      doc.setFontSize(16);
      doc.text("Puntuaciones Detalladas", 105, yPos, { align: 'center' });
      yPos += 10;
      
      const grupos = obtenerGrupos();
      const headers = ["Equipo", "Docente", "Ronda 1", "Ronda 2", "Ronda 3", "Final"];
      
      const data = grupos.map(grupo => {
        const ronda1 = puntuaciones.ronda1[grupo.nombre] || 0;
        const ronda2 = puntuaciones.ronda2[grupo.nombre] || 0;
        const ronda3 = puntuaciones.ronda3[grupo.nombre] || 0;
        const final = puntuaciones.final[grupo.nombre] || 0;
        
        return [
          grupo.nombre,
          grupo.docente,
          ronda1.toString(),
          ronda2.toString(),
          ronda3.toString(),
          final.toString()
        ];
      });
      
      doc.autoTable({
        startY: yPos,
        head: [headers],
        body: data,
        margin: { left: 10 },
        styles: { fontSize: 10 },
        headStyles: { fillColor: [255, 107, 107] }
      });
      
      doc.save('resultados_caza_tesoro.pdf');
    }
  </script>
</body>
</html>